name: Publish Docker & Sync Repos

on:
  push:
    branches:
      - main
      - dev
  workflow_dispatch:

concurrency:
  group: publish-docker-${{ github.ref }}
  cancel-in-progress: true

env:
  IMAGE_NAME: linuxcts
  DOCKER_USER: ${{ toLower(secrets.DOCKERHUB_USERNAME) }}

jobs:
  publish-docker:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Set up QEMU (for multi-arch)
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # âœ… æ„å»ºç¼“å­˜æœºåˆ¶
      - name: Set up build cache
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.ref }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      - name: Build and push Docker image (multi-arch)
        uses: docker/build-push-action@v6
        with:
          context: .
          # åŒæ—¶æ„å»º amd64 + arm64 ä¸¤ç§æ¶æ„
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            docker.io/${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest
            docker.io/${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          cache-from: type=local,src=/tmp/.buildx-cache
          cache-to: type=local,dest=/tmp/.buildx-cache,mode=max

      - name: Output pushed image names
        run: |
          echo "âœ… Pushed images:"
          echo "  docker.io/${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:latest"
          echo "  docker.io/${{ env.DOCKER_USER }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

  # ğŸš€ è‡ªåŠ¨åŒæ­¥åˆ° Gitee
  gitee:
    needs: publish-docker
    runs-on: ubuntu-latest
    steps:
      - name: Sync to Gitee
        uses: wearerequired/git-mirror-action@master
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_SSH_KEY }}
        with:
          source-repo: git@github.com:muaimingjun/LinuxCTS.git
          destination-repo: git@gitee.com:muaimingjun/LinuxCTS.git

  # ğŸš€ è‡ªåŠ¨åŒæ­¥åˆ° GitCode
  gitcode:
    needs: publish-docker
    runs-on: ubuntu-latest
    steps:
      - name: Sync to GitCode
        uses: wearerequired/git-mirror-action@master
        env:
          SSH_PRIVATE_KEY: ${{ secrets.GITEE_SSH_KEY }}
        with:
          source-repo: git@github.com:muaimingjun/LinuxCTS.git
          destination-repo: git@gitcode.com:muaimingjun/LinuxCTS.git
